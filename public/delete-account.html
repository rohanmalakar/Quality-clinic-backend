<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delete Account</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 2rem auto; padding: 1rem; }
    label { display:block; margin-top: 0.75rem; }
    input, textarea { width:100%; padding:0.5rem; margin-top:0.25rem; box-sizing: border-box; }
    button { margin-top: 1rem; padding: 0.6rem 1rem; }
    .status { margin-top: 1rem; padding: 0.6rem; border-radius:4px; }
    .success { background: #e6ffed; border: 1px solid #2ecc71; color: #114b2b; }
    .error { background: #ffe6e6; border: 1px solid #ff4d4d; color: #6b0000; }
  </style>
</head>
<body>
  <h1>Delete Account</h1>
  <p>Enter your phone number to receive an OTP. After verification, your account will be deleted.</p>

  <div>
    <label>
      Phone number (e.g. +9665XXXXXXXX)
      <input type="tel" id="phone" placeholder="+9665XXXXXXXX" required />
    </label>
    <button id="sendOtpBtn">Send OTP</button>
  </div>

  <div id="otpSection" style="display:none;">
    <label>
      Enter OTP
      <input type="number" id="otp" inputmode="numeric" />
    </label>
    <button id="verifyBtn">Verify & Delete</button>
  </div>

  <div id="status" class="status" style="display:none;"></div>

  <script>
    const statusEl = document.getElementById('status');
    const phoneEl = document.getElementById('phone');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpSection = document.getElementById('otpSection');
    const otpEl = document.getElementById('otp');
    const verifyBtn = document.getElementById('verifyBtn');

    let deleteHash = null;

    function showStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type === 'error' ? 'error' : 'success');
      statusEl.style.display = 'block';
    }

  sendOtpBtn.addEventListener('click', async () => {
      statusEl.style.display = 'none';
      const phone = phoneEl.value.trim();
      if (!phone) {
        showStatus('Please enter a valid phone number.', 'error');
        return;
      }
      sendOtpBtn.disabled = true;
      try {
        const res = await fetch('/user/delete_phone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone_number: phone })
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json?.success) {
          const msg = json?.data?.message || json?.message || 'Failed to send OTP';
          showStatus(msg, 'error');
          sendOtpBtn.disabled = false;
          return;
        }
        deleteHash = json.data.hash;
        try { localStorage.setItem('qc_delete_hash', deleteHash); } catch (e) {}
        otpSection.style.display = 'block';
        showStatus('OTP sent. Please check your phone.', 'success');
      } catch (err) {
        showStatus('Network error: ' + err.message, 'error');
      } finally {
        sendOtpBtn.disabled = false;
      }
    });

    verifyBtn.addEventListener('click', async () => {
      statusEl.style.display = 'none';
      const otp = otpEl.value.trim();
      if (!deleteHash) {
        showStatus('Please request an OTP first.', 'error');
        return;
      }
      if (!otp) {
        showStatus('Please enter the OTP.', 'error');
        return;
      }
      verifyBtn.disabled = true;
      try {
        const res = await fetch('/user/delete_verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hash: deleteHash, otp: Number(otp) })
        });
        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json?.success) {
          const msg = json?.data?.message || json?.message || 'Failed to verify OTP';
          showStatus(msg, 'error');
          verifyBtn.disabled = false;
          return;
        }
        showStatus('Your account has been deleted successfully.', 'success');
        // Optionally disable controls
        phoneEl.disabled = true;
        otpEl.disabled = true;
        sendOtpBtn.disabled = true;
        verifyBtn.disabled = true;
      } catch (err) {
        showStatus('Network error: ' + err.message, 'error');
      } finally {
        // keep disabled on success
      }
    });
  </script>
  <p style="margin-top:1rem;">
    Prefer a dedicated page for verification? <a href="/delete-account-verify.html">Open verification page</a>
  </p>
</body>
</html>